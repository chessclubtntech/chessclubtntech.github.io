<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="tournament-container">
        <h1>Tournament</h1>
        
        <!-- Dropdowns for selecting users -->
        <div class="user-selection">
            <label for="user1Dropdown">Select User 1:</label>
            <select id="user1Dropdown">
                <option value="">--Select User 1--</option>
            </select>

            <label for="user2Dropdown">Select User 2:</label>
            <select id="user2Dropdown">
                <option value="">--Select User 2--</option>
            </select>
        </div>

        <!-- Buttons for match result input -->
        <div class="match-results">
            <div class="user1-buttons">
                <button class="win-btn">Win</button>
                <button class="draw-btn">Draw</button>
                <button class="lose-btn">Lose</button>
            </div>
            
            <div class="user2-buttons">
                <button class="win-btn">Win</button>
                <button class="draw-btn">Draw</button>
                <button class="lose-btn">Lose</button>
            </div>
        </div>
        
        <!-- Submit button for match results -->
        <button id="submitResult" style="display:none;">Submit Results</button>
    </div>

    <script>
        $(document).ready(function() {
            // Fetch all users from the server and populate the dropdowns
            fetchAllUsers();

            // Event listener for dropdown changes
            $('#user1Dropdown, #user2Dropdown').change(function() {
                checkSubmitVisibility();
            });

            // Event listeners for result buttons
            $('.win-btn, .draw-btn, .lose-btn').click(function() {
                $(this).siblings().removeClass('selected');
                $(this).addClass('selected');
                checkSubmitVisibility();
            });

            // Event listener for submit button
            $('#submitResult').click(function() {
                const user1Id = $('#user1Dropdown').val();
                const user2Id = $('#user2Dropdown').val();
                const user1Outcome = $('.user1-buttons .selected').text();
                const user2Outcome = $('.user2-buttons .selected').text();

                if (user1Id && user2Id && user1Outcome && user2Outcome) {
                    submitResult(user1Id, user2Id, user1Outcome, user2Outcome);
                } else {
                    alert('Please select both users and their outcomes before submitting.');
                }
            });

            function fetchAllUsers() {
                $.ajax({
                    url: '/api/get-all-users',
                    method: 'GET',
                    success: function(data) {
                        populateDropdowns(data.users);
                    },
                    error: function(err) {
                        console.error('Error fetching users:', err);
                    }
                });
            }

            function populateDropdowns(users) {
                users.forEach(function(user) {
                    $('#user1Dropdown').append(`<option value="${user._id}">${user.username}</option>`);
                    $('#user2Dropdown').append(`<option value="${user._id}">${user.username}</option>`);
                });
            }

            function checkSubmitVisibility() {
                if ($('#user1Dropdown').val() && $('#user2Dropdown').val() && 
                    $('.user1-buttons .selected').length && $('.user2-buttons .selected').length) {
                    $('#submitResult').show();
                } else {
                    $('#submitResult').hide();
                }
            }

            function submitResult(user1Id, user2Id, user1Outcome, user2Outcome) {
                const outcomes = {
                    'Win': 1,
                    'Draw': 0.5,
                    'Lose': 0
                };

                updateUserGameData(user1Id, outcomes[user1Outcome]);
                updateUserGameData(user2Id, outcomes[user2Outcome]);
            }

            function updateUserGameData(userId, outcome) {
                $.ajax({
                    url: '/api/update-user-game-data',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId: userId, outcome: outcome }),
                    success: function(data) {
                        console.log('User game data updated successfully:', data);
                    },
                    error: function(err) {
                        console.error('Error updating user game data:', err);
                    }
                });
            }
        });
    </script>
</body>
</html>
