<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archives</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Include Chessboard.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <style>
        h2 {
            text-align: center;
            font-size: 2rem;
            color: #ecba13;
            text-shadow: 0 0 10px #fff;
            margin-top: 50px;
        }

        /* Center everything */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .plugin-section {
            margin-bottom: 20px;
            right: -120px;
            position: relative;
        }

        .move-list-container {
            height: 500px;
            /* Adjust height as needed */
            overflow-y: auto;
            padding: 10px;
            position: relative;
            right: -130px;
            top: 50px;
        }

        .move-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .move-list li {
            cursor: pointer;
            padding: 5px;
        }

        .move-list li:hover {
            background-color: #f0f0f0;
        }

        .move-navigation {
            top: 600px;
            right: 250px;
            position: relative;
            padding: 5px;
        }

        .navigation-links {
            position: relative;
            right: -250px;
            top: -100px;
        }
        .home-button-leaderboard {
            position: relative;
            right:430px;
            top:100px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Main Page Content -->
        <h1 class="leaderboard-h1">Archives</h1>
        <ul class="navigation-links">
            <li class="home-button-leaderboard"><a href="main.html"><i class="fas fa-home"></i></a></li>
        </ul>
        <!-- Plugin Section -->
        <div class="plugin-section">
            <h2>Game Viewer</h2>
            <div id="board" style="width: 400px"></div>
            <textarea id="pgnInput" placeholder="Enter PGN or FEN"></textarea>
            <div id="gameInfo"></div>
            <div class="loadGameBtn">
                <button id="loadGameBtn">Load Game</button>
            </div>
        </div>
        <!-- Move List Section -->
        <div class="move-list-container">
            <ul id="moveList" class="move-list"></ul>
        </div>
        <!-- Previous and Next Move Buttons -->
        <div class="move-navigation">
            <button id="prevMoveBtn">Previous Move</button>
            <button id="nextMoveBtn">Next Move</button>
        </div>
        <!-- Game Files Section -->
        <div class="game-files">
            <h2>Game Files</h2>
            <ul>
                <li><a href="#" class="game-file-link" data-file="assets/pgns/lichess_pgn_2024.06.01_Meme_master_vs_ComputerConnor.w4w6DUVl.pgn">Joel(W) vs Connor(B)</a></li>
                <li><a href="#" class="game-file-link" data-file="assets/pgns/Donald Byrne_vs_Bobby Fischer_1956.__.__.pgn">Donald Byrne(W) vs Bobby Fischer(B)</a></li>
                <li><a href="#" class="game-file-link" data-file="assets/pgns/Garry Kasparov_vs_Veselin Topalov_1999.__.__.pgn">Garry Kasparov(W) vs Veselin Topalov(B)</a></li>
                <li><a href="#" class="game-file-link" data-file="assets/pgns/Anatoly Karpov_vs_Garry Kasparov_1985.__.__.pgn">Anatoly Karpov(W) vs Garry Kasparov(B)</a></li>
                <li><a href="#" class="game-file-link" data-file="assets/pgns/Paul Morphy_vs_Duke of Brunswick and Count Isouard_1858.__.__.pgn">Paul Morphy(W) vs Duke of Brunswick and Count Isouard(B)</a></li>
            </ul>
        </div>
        <!-- Include jQuery -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script>
        <!-- Include Chess.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js" defer></script>
        <!-- Include Chessboard.js -->
        <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous" onload="initializeChessboard()" onerror="handleChessboardError()" defer></script>
        <script>
            var game; // Declare game variable outside function to make it accessible globally
            var currentMoveIndex = 0;

            function handleChessboardError() {
                console.error('Chessboard.js failed to load.');
            }

            function displayGameInfo(pgn) {
                // Parse PGN to extract player names and their colors
                var players = getPgnPlayers(pgn);
                if (players) {
                    var gameInfoDiv = document.getElementById('gameInfo');
                    gameInfoDiv.innerHTML = `<p>${players.white} (W) vs ${players.black} (B)</p>`;
                }
            }

            function getPgnPlayers(pgn) {
                var regex = /\[White "([^"]*)"\][\s\S]*\[Black "([^"]*)"\]/;
                var match = pgn.match(regex);
                if (match) {
                    return {
                        white: match[1],
                        black: match[2]
                    };
                }
                return null;
            }

            function initializeChessboard() {
                console.log('Chessboard.js is loaded and initialized.');
                // Check if Chessboard object is available
                if (typeof Chessboard === 'undefined') {
                    console.error('Chessboard.js is not loaded properly.');
                    return;
                }
                // Attach the event listener for the "Load Game" button if it exists
                var loadGameBtn = document.getElementById('loadGameBtn');
                if (loadGameBtn) {
                    loadGameBtn.addEventListener('click', function() {
                        var pgnOrFen = document.getElementById('pgnInput').value;
                        game = new Chess();
                        var isValidMove = game.load_pgn(pgnOrFen) || game.load(pgnOrFen);
                        if (isValidMove) {
                            var initialPosition = game.history().length > 0 ? calculatePositionAfterMoves(game.history().slice(0, 1)) : game.fen();
                            renderMoveList(game.history(), initialPosition); // Pass initial position to renderMoveList
                            currentMoveIndex = 0; // Reset current move index
                            // Display game info after loading the game
                            displayGameInfo(pgnOrFen);
                        } else {
                            alert('Invalid PGN or FEN');
                        }
                    });
                }
                // Attach event listeners for previous and next move buttons if they exist
                var prevMoveBtn = document.getElementById('prevMoveBtn');
                var nextMoveBtn = document.getElementById('nextMoveBtn');
                if (prevMoveBtn && nextMoveBtn) {
                    prevMoveBtn.addEventListener('click', function() {
                        if (currentMoveIndex > 0) {
                            currentMoveIndex--;
                            var newPosition = calculatePositionAfterMoves(game.history().slice(0, currentMoveIndex + 1));
                            renderChessboard(newPosition);
                        }
                    });
                    nextMoveBtn.addEventListener('click', function() {
                        if (currentMoveIndex < game.history().length - 1) {
                            currentMoveIndex++;
                            var newPosition = calculatePositionAfterMoves(game.history().slice(0, currentMoveIndex + 1));
                            renderChessboard(newPosition);
                        }
                    });
                }
            }

            function renderMoveList(moves, initialPosition) {
                var moveListElement = document.getElementById('moveList');
                moveListElement.innerHTML = '';
                for (var i = 0; i < moves.length; i++) {
                    var moveNumber = Math.floor(i / 2) + 1;
                    var moveText = (i % 2 === 0 ? moveNumber + '. ' : '') + moves[i];
                    var listItem = document.createElement('li');
                    listItem.textContent = moveText;
                    listItem.classList.add('move');
                    listItem.dataset.moveIndex = i;
                    moveListElement.appendChild(listItem);
                    listItem.addEventListener('click', function() {
                        var moveIndex = parseInt(this.dataset.moveIndex);
                        currentMoveIndex = moveIndex; // Update current move index
                        var newPosition = calculatePositionAfterMoves(game.history().slice(0, moveIndex + 1));
                        renderChessboard(newPosition);
                    });
                }
                // Render the chessboard with the initial position
                renderChessboard(initialPosition);
            }

            function calculatePositionAfterMoves(moves) {
                var tempGame = new Chess(); // Create a temporary game object
                for (var i = 0; i < moves.length; i++) {
                    tempGame.move(moves[i]); // Apply each move to the temporary game object
                }
                return tempGame.fen(); // Return the FEN of the temporary game object
            }

            function renderChessboard(fen) {
                var boardContainer = document.getElementById('board');
                boardContainer.innerHTML = ''; // Clear the board container
                var board = Chessboard(boardContainer, {
                    draggable: true,
                    position: fen
                });
            }
            // Function to handle loading PGN from a file
            function loadPgnFromFile(filename) {
                // Assuming you have the PGN files stored in the same directory as your HTML file
                var filePath = filename;
                // Assuming you're using jQuery to make AJAX requests
                $.ajax({
                    url: filePath,
                    success: function(data) {
                        document.getElementById('pgnInput').value = data;
                        document.getElementById('loadGameBtn').click();
                    },
                    error: function() {
                        alert('Error loading PGN file');
                    }
                });
            }
            // Event listener for game file links
            document.addEventListener('DOMContentLoaded', function() {
                var gameFileLinks = document.querySelectorAll('.game-file-link');
                gameFileLinks.forEach(function(link) {
                    link.addEventListener('click', function(event) {
                        event.preventDefault(); // Prevent the default link behavior
                        var filename = this.dataset.file;
                        loadPgnFromFile(filename);
                    });
                });
            });
            // Fetch selected background image from localStorage
            const selectedBackground = localStorage.getItem('backgroundImage');
            // Set the selected background as the body background
            if (selectedBackground) {
                document.body.style.backgroundImage = `url(${selectedBackground})`;
            }
        </script>
</body>
</html>